id: eval_enforce_amend_pushed
name: Amend Pushed Commit Protection
description: Verify warning/block on amending commits already pushed
category: enforcement
rule_ref: rule_tool_005
patterns_ref: enforcement_patterns.json#amend_pushed_commit

test_cases:
  - id: amend_unpushed
    description: Allow amend of unpushed commit
    scenario:
      git_status: "Your branch is ahead of 'origin/main' by 1 commit"
    command: "git commit --amend -m 'updated message'"
    expected: allowed

  - id: amend_pushed
    description: Warn/block amend of pushed commit
    scenario:
      git_status: "Your branch is up to date with 'origin/main'"
    command: "git commit --amend -m 'updated message'"
    expected: warn

  - id: amend_behind
    description: Warn/block amend when behind remote
    scenario:
      git_status: "Your branch is behind 'origin/main' by 2 commits"
    command: "git commit --amend"
    expected: warn

  - id: amend_no_remote
    description: Allow amend with no remote tracking
    scenario:
      git_status: "Your branch is not tracking a remote branch"
    command: "git commit --amend -m 'message'"
    expected: allowed

implementation_notes:
  - On git commit --amend, run git status to check
  - Parse output for "ahead of", "up to date", "behind"
  - If not ahead, warn user about history rewrite
  - Requires running git status as pre-check

metrics:
  - unpushed_amend_allowed
  - pushed_amend_warned
  - history_rewrite_prevented

pass_criteria:
  - unpushed_commits: allowed
  - pushed_commits: warn

flaky: false
mock_mode: true
