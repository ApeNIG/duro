id: eval_enforce_read_before_edit
name: Read Before Edit Gate
description: Verify Edit tool requires prior Read of same file
category: enforcement
rule_ref: rule_workflow_001
patterns_ref: enforcement_patterns.json#read_before_edit

test_cases:
  - id: edit_without_read
    description: Block Edit without prior Read
    scenario:
      - tool: Edit
        file_path: /tmp/test.py
        old_string: "foo"
        new_string: "bar"
    prior_reads: []
    expected: blocked

  - id: edit_with_read
    description: Allow Edit after Read
    scenario:
      - tool: Read
        file_path: /tmp/test.py
      - tool: Edit
        file_path: /tmp/test.py
        old_string: "foo"
        new_string: "bar"
    prior_reads: ["/tmp/test.py"]
    expected: allowed

  - id: edit_wrong_file
    description: Block Edit of different file than Read
    scenario:
      - tool: Read
        file_path: /tmp/other.py
      - tool: Edit
        file_path: /tmp/test.py
        old_string: "foo"
        new_string: "bar"
    prior_reads: ["/tmp/other.py"]
    expected: blocked

  - id: edit_after_multiple_reads
    description: Allow Edit after multiple Reads
    scenario:
      - tool: Read
        file_path: /tmp/a.py
      - tool: Read
        file_path: /tmp/b.py
      - tool: Edit
        file_path: /tmp/b.py
        old_string: "foo"
        new_string: "bar"
    prior_reads: ["/tmp/a.py", "/tmp/b.py"]
    expected: allowed

implementation_notes:
  - Track Read calls in session state
  - Store set of file paths that have been Read
  - On Edit, check if file_path in read set
  - Session state clears between conversations

metrics:
  - blocked_without_read
  - allowed_with_read
  - context_mismatch_prevented

pass_criteria:
  - edits_without_read: blocked
  - edits_with_read: allowed

flaky: false
mock_mode: true
