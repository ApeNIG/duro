# Summary: 2026-02-14

## Learnings
- When implementing FTS5 triggers for SQLite, triggers cannot call Python code. The text column must be populated separately via Python after insert/reindex. Solution: call rebuild_fts() after reindex() at startup to populate semantic text.
- sqlite-vec vec0 tables use KNN query pattern: WHERE embedding MATCH ? AND k = ? for O(log n) performance. Do not use brute force vec_distance_cosine() which is O(n).
- Threading.Lock in Python is in-process only - does not protect against multi-process race conditions. For cross-process safety, use SQLite transactions with BEGIN IMMEDIATE, or external locking (portalocker library on Windows).
- When documenting limitations, include: Symptoms (how it fails), When it triggers (specific conditions), Severity, Detection method, Mitigations ranked by effort/safety, and explicit Non-goals. This makes the doc actionable rather than placeholder-y.
- When implementing temporal queries with text-based ISO timestamp comparisons in SQLite, always normalize input timestamps to a consistent format (Z-suffix) before comparison. Mixed formats (+00:00 vs Z) can cause subtle comparison bugs even though they represent the same time.
- For conditional expensive operations (like FTS rebuild), check if the work is actually needed before doing it. In reindex(), checking missing_text_count > 0 before calling rebuild_fts() avoids O(n) overhead when FTS is already complete.
- When consolidating duplicate code into a shared utility (like time_utils.py), the migration path is: 1) Create utility, 2) Update imports across files, 3) Fix any semantic bugs discovered during consolidation (like timezone mismatch in ranking_config.py).
- When adding new SQLite columns via migrations, the smoke test/pre-push hook will fail if the migration hasn't been applied to the actual database being tested. Fix: auto-apply migrations in smoke_test.py before running tests, or fail fast with a clear "run migration X" message.
- Always log the database path at the start of test runners. Having two plausible DB paths on disk (e.g., ~/.duro/index.db vs ~/.agent/memory/index.db) causes confusion. Explicit logging prevents wrong-DB debugging sessions.
- Pre-push hooks that run smoke tests are valuable - they caught the migration drift before it hit CI. The error was noisy (500 "no such column" lines) but the failure was correct. Improving the error message (auto-migrate or fail fast) makes the hook more developer-friendly.

## Tasks Completed
- Implement Phase 1B semantic search with FTS5 and graceful degradation: Complete. FTS5 full-text search working with BM25 scoring. vec0 KNN pattern ready for sqlite-vec. Hybrid search degrades gracefully to FTS-only mode. 172 artifacts indexed with semantic text.
- Upgrade health check with FTS completeness and embedding coverage metrics: Complete. Health check now reports: fts_text_missing_count, coverage_pct, vec_table_exists, embeddings_count vs artifacts_count, first_broken_entry for audit chain. Overall status correctly promotes errors.
- Create migration system with schema_migrations tracking: Complete. migrations/runner.py with checksum verification, m001_add_vectors.py for FTS5+vec0 tables. Migrations are idempotent and tracked.
- Document multi-process audit chain limitation: Complete. KNOWN_LIMITATIONS.md created with proper structure: symptoms, triggers, severity, detection, mitigations ranked by effort/safety, and explicit non-goals.
- Write Phase 1B integration tests: Complete. tests/test_phase1b_integration.py with golden-path (store->FTS populated) and failure-path (FTS fail->save succeeds) tests. All 8 tests pass.
- Cleanup sprint: Centralized datetime utils, fixed timezone mismatch, consolidated migration tables, made FTS rebuild conditional: Created time_utils.py with utc_now(), utc_now_iso(), parse_iso_datetime(), days_since(), normalize_iso_z(). Updated 8 files. Fixed ranking_config.py aware vs naive datetime bug. Migration tracking now single table (schema_migrations).
- Phase 2: Temporal fields and fact supersession: Added valid_from, valid_until, superseded_by, importance, pinned to fact schema. Created m002_add_temporal migration. Implemented supersede_fact(), add_relation(), get_relations(), query_current_facts(). Added MCP tools duro_supersede_fact and duro_get_related. All tests pass.
- Phase 4: Confidence Decay & Maintenance implementation: Completed. Added decay.py with explicit math, migration m003_add_reinforcement, 4 MCP tools (duro_apply_decay, duro_reembed, duro_maintenance_report, duro_reinforce_fact), and golden decay test (5/5 passing). Committed fba51ff.
- Fix migration drift in pre-push hook: Push initially failed because m003 migration wasn't applied to ~/.agent/memory/index.db. Applied migration manually, push succeeded. Then improved smoke_test.py to auto-apply migrations.
- Improve test infrastructure robustness: Added DB path logging to smoke_test.py, auto-migration detection/apply before tests, moved tests to tests/ folder with proper pytest structure. Committed 746d1bc.
- Polish test infrastructure with stable imports and env var control: Added exports to migrations/__init__.py, DURO_SMOKE_APPLY_MIGRATIONS env var (=1 auto-apply, =0 strict), migrations dir logging. Commits d72a4b9 and 4b66563.
- Implement Decision Outcomes v1 - wire decisions into feedback loop: Complete. Added decisions_used to episodes, auto-generate decision updates in store_evaluation with de-dupe, deterministic status rules (validated >= 0.7, reversed <= 0.3), guardrails for decision updates. All 6 smoke tests pass.
- Session: Decision Outcomes v1 implementation + code review fixes: Complete. Implemented decisions_used in episodes, auto-generate decision updates in evaluations with de-dupe, deterministic status rules (validated >= 0.7, reversed <= 0.3). Applied 5 code review fixes: explicit None checks, cleaner audit trail (verified_at vs last_evaluated_at), removed negation logic, tighter test tolerance. All 6 smoke tests pass. Pushed as commit 9fd9a15.
- Implement Lean Context v1 - three-mode context loading for duro_load_context: Complete. Added full/lean/minimal modes. Lean mode: 77% token reduction (28Kâ†’6.5K chars). New helpers: load_today_tasks_only(), load_core_trimmed(), load_recent_summary(), get_active_decisions(). Updated CLAUDE.md to call mode="lean". All smoke tests pass. Pushed as commits 577cc0c (duro-mcp) and a132863 (.claude).
- Run Planify on stride-server reward system feature: Generated comprehensive implementation plan including Prisma schema, 5 API endpoints, 4 UI components, risks, and 23 tasks. Cost: $0.14. Used OpenAI-only config as workaround for missing Anthropic key.

## Stats
- Original size: 55884 chars
- Total learnings: 72
- Tasks completed: 60
- Failures logged: 0