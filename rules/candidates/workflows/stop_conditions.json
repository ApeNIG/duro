{
  "id": "rule_004",
  "name": "Stop Conditions and Escalation",
  "type": "hard",
  "priority": 1,
  "description": "Define when to stop retrying and switch strategy. The difference between an agent and a slot machine.",

  "general_stop_conditions": {
    "max_retries_same_approach": 3,
    "max_retries_same_tool": 2,
    "max_time_single_task_minutes": 30,
    "max_consecutive_errors": 3
  },

  "escalation_ladder": [
    {
      "step": 1,
      "trigger": "First failure",
      "action": "Retry with modified parameters (prompt, settings)",
      "log": true
    },
    {
      "step": 2,
      "trigger": "Second failure (same approach)",
      "action": "Check rules for known failure patterns. If match, follow rule's fallback ladder.",
      "log": true
    },
    {
      "step": 3,
      "trigger": "Third failure (same approach)",
      "action": "Switch tool or approach entirely. Consult tool_selection rule.",
      "log": true,
      "notify_user": false
    },
    {
      "step": 4,
      "trigger": "Failure after tool switch",
      "action": "Ask user for preference: continue trying, switch approach, or abandon task",
      "log": true,
      "notify_user": true
    },
    {
      "step": 5,
      "trigger": "Max time or retries exceeded",
      "action": "Stop. Report what was tried, what failed, and recommend next steps.",
      "log": true,
      "notify_user": true
    }
  ],

  "task_specific_overrides": {
    "image_generation_faces": {
      "max_retries_same_tool": 1,
      "reason": "Known limitation - don't waste time, switch tool immediately"
    },
    "api_calls": {
      "max_retries_same_approach": 5,
      "reason": "Network issues may be transient"
    },
    "file_operations": {
      "max_retries_same_approach": 2,
      "reason": "File errors usually indicate real problems, not transient"
    }
  },

  "logging_requirements": {
    "on_failure": ["task_type", "tool_used", "error_message", "attempt_number", "timestamp"],
    "on_escalation": ["from_step", "to_step", "reason"],
    "on_success_after_retry": ["attempts_needed", "what_worked"]
  },

  "anti_patterns": [
    {
      "name": "Infinite retry loop",
      "description": "Retrying the same thing hoping for different results",
      "prevention": "max_retries_same_approach limit"
    },
    {
      "name": "Silent failure",
      "description": "Failing without informing user",
      "prevention": "notify_user on step 4+"
    },
    {
      "name": "Sunk cost fallacy",
      "description": "Continuing because of time already spent",
      "prevention": "max_time_single_task_minutes limit"
    }
  ],

  "eval_linkage": {
    "target_eval": "all",
    "metrics": ["time_seconds", "tool_calls"],
    "goal": "Reduce time wasted on doomed approaches"
  },

  "confidence": 0.9,
  "source": "best_practices",
  "last_validated": "2026-02-10",
  "times_applied": 0
}
